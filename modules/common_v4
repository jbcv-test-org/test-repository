#%Module1.0

set prefix __CONDA_BASE__/__APPS_SUBDIR__
set package __CONDA_INSTALL_BASENAME__

# Prevent running this module with a running payu module
conflict payu

# Warn if another conda environment is already loaded
if { [info exists env(CONDA_DEFAULT_ENV)] } {
    puts stderr "Warning: Another conda environment is currently loaded (CONDA_DEFAULT_ENV: $env(CONDA_DEFAULT_ENV))"
}

# Name of this module's environment
lassign [split [module-info name] {/}] module_name module_version
set condaenv "${module_version}"
set basedir "$prefix/$package/envs/$condaenv"
if {![ file exists $basedir ]} {
    # For modulenames which are $ENVIRONMENT/$VERSION, rather than conda/$ENIRONMENT-$VERSION
    set condaenv "${module_name}-${module_version}"
    set basedir "$prefix/$package/envs/$condaenv"
}

set myscripts [ file normalize __CONDA_BASE__/__SCRIPT_SUBDIR__/$condaenv.d/bin ]
set overlay_path [ string map {/conda/ /envs/} $basedir ].sqsh

module load singularity

prepend-path CONTAINER_OVERLAY_PATH $overlay_path

# Add launcher script directory to PATH
prepend-path PATH $myscripts

### Extra env to get other things working
setenv OMPI_MCA_orte_launch_agent $myscripts/orted